# FreeBSD 5.3 RELEASE amd64 发行公告（2004 年 11 月 6 日）

**FreeBSD 项目**

版权 © 2000, 2001, 2002, 2003, 2004 FreeBSD 文档项目

```
$FreeBSD: src/release/doc/en_US.ISO8859-1/relnotes/common/new.sgml,v 1.761.2.12.2.3 2004/11/03 10:12:51 hrs Exp $
```

FreeBSD 5.3-RELEASE 的发布说明包含自 5.2.1-RELEASE 以来对 FreeBSD 基本系统所做更改的摘要。本文件列出了自上一个版本发布以来发布的相关安全公告，以及对 FreeBSD 内核和用户空间的重大更改。还提供了一些关于升级的简要说明。

## [1 介绍]()

本文档包含了 FreeBSD 5.3-RELEASE 在 AMD64 硬件平台上的发布说明。它描述了 FreeBSD 最近添加、修改或删除的功能。还提供了一些关于从先前版本升级的说明。

该版本的 FreeBSD 5.3-RELEASE 是一个发布版，您可以在 [ftp://ftp.FreeBSD.org/](ftp://ftp.freebsd.org/) 或任何镜像站点找到它。有关获取此版本（或其他版本）发布的更多信息，请参阅 [FreeBSD 手册](http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/) 中的 [“获取 FreeBSD”](http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/mirrors.html) 附录。

建议所有用户在安装 FreeBSD 之前查阅发布说明的 errata。errata 文档会更新在发布周期结束或发布后发现的“突发”信息。通常，它包含已知的错误、安全公告和文档修正。FreeBSD 5.3-RELEASE 的最新 errata 副本可以在 FreeBSD 网站上找到。

---

## [2 新特性]()

本节描述自 5.2.1-RELEASE 以来 FreeBSD 中最明显的新增或更改的功能。通常，这里描述的更改是独特的，属于 5-STABLE 分支，除非特别标注为 [MERGED] 特性。

典型的发布说明项目包括发布后发布的安全公告、新驱动程序或硬件支持、新命令或选项、主要 bug 修复或贡献的软件升级。它们还可能列出主要 Port/包或发布工程实践的更改。显然，发布说明不能列出每个版本之间对 FreeBSD 所做的所有更改；本文档主要关注安全公告、用户可见的更改以及主要的架构改进。

### [2.1 安全公告]()

修复了 [mksnap_ffs(8)](http://www.freebsd.org/cgi/man.cgi?query=mksnap_ffs&sektion=8&manpath=FreeBSD+5.3-RELEASE) 中的一个 bug，该 bug 会导致创建文件系统快照时重置文件系统的标志为默认值。这个问题的后果取决于本地使用情况，但可能包括禁用扩展访问控制列表或启用存储在不受信任文件系统上的 setuid 可执行文件。此 bug 还影响了使用 [mksnap_ffs(8)](http://www.freebsd.org/cgi/man.cgi?query=mksnap_ffs&sektion=8&manpath=FreeBSD+5.3-RELEASE) 的 [dump(8)](http://www.freebsd.org/cgi/man.cgi?query=dump&sektion=8&manpath=FreeBSD+5.3-RELEASE) -L 选项。请注意，[mksnap_ffs(8)](http://www.freebsd.org/cgi/man.cgi?query=mksnap_ffs&sektion=8&manpath=FreeBSD+5.3-RELEASE) 通常仅对超级用户和操作员组成员可用。更多信息请参见安全公告 [FreeBSD-SA-04:01](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:01.mksnap_ffs.asc)。

修复了 System V 共享内存接口（特别是 [shmat(2)](http://www.freebsd.org/cgi/man.cgi?query=shmat&sektion=2&manpath=FreeBSD+5.3-RELEASE) 系统调用）中的一个 bug。此 bug 可能导致共享内存段引用未分配的内核内存，从而允许本地攻击者未经授权访问内核内存的某些部分，可能导致敏感信息泄露、绕过访问控制机制或特权提升。更多详细信息请参见安全公告 [FreeBSD-SA-04:02](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:02.shmat.asc)。[MERGED]

修复了 [jail_attach(2)](http://www.freebsd.org/cgi/man.cgi?query=jail_attach&sektion=2&manpath=FreeBSD+5.3-RELEASE) 系统调用中的编程错误。此错误可能允许在 [jail(8)](http://www.freebsd.org/cgi/man.cgi?query=jail&sektion=8&manpath=FreeBSD+5.3-RELEASE) 环境中具有超级用户权限的进程将其根目录更改为另一个 jail 的根目录，从而获得对目标 jail 中的文件和目录的完全读写访问权限。更多信息请参见安全公告 [FreeBSD-SA-04:03](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:03.jail.asc)。

通过限制一次可以保持的乱序 TCP 数据段数量，防止了对 FreeBSD TCP 堆栈的潜在低带宽拒绝服务攻击。更多详细信息请参见安全公告 [FreeBSD-SA-04:04](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:04.tcp.asc)。[MERGED]

修复了 **OpenSSL** SSL/TLS ChangeCipherSpec 消息处理中的一个 bug，该问题可能导致空指针解引用。攻击者可以利用该漏洞使使用 **OpenSSL** 的应用程序崩溃，从而导致系统的拒绝服务。更多信息请参见安全公告 [FreeBSD-SA-04:05](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:05.openssl.asc)。[MERGED]

修复了处理某些 IPv6 套接字选项时 [setsockopt(2)](http://www.freebsd.org/cgi/man.cgi?query=setsockopt&sektion=2&manpath=FreeBSD+5.3-RELEASE) 系统调用中的编程错误。此错误允许本地攻击者导致系统崩溃，并可能允许未经授权访问内核内存的某些部分，可能导致敏感信息泄露、绕过访问控制机制或特权提升。更多信息请参见安全公告 [FreeBSD-SA-04:06](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:06.ipv6.asc)。

修复了 **CVS** 中的两个编程错误。它们允许服务器覆盖客户端上的任意文件，以及客户端在访问远程 CVS 仓库时读取服务器上的任意文件。更多详细信息请参见安全公告 [FreeBSD-SA-04:07](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:07.cvs.asc)。[MERGED]

修复了 **Heimdal** 中的一个 bug，该 bug 会导致它未能充分检查跨自治领域的身份验证。更多信息请参见安全公告 [FreeBSD-SA-04:08](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:08.heimdal.asc)。[MERGED]

修复了 **CVS** 中的一个编程错误，该错误可能允许恶意客户端覆盖服务器内存的任意部分。更多信息请参见安全公告 [FreeBSD-SA-04:10](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:10.cvs.asc)。[MERGED]

修复了实现 [msync(2)](http://www.freebsd.org/cgi/man.cgi?query=msync&sektion=2&manpath=FreeBSD+5.3-RELEASE) 系统调用时可能导致的缓存一致性问题，涉及 `MS\_INVALIDATE` 操作。然而，作为关闭此安全问题的副作用，`MS\_INVALIDATE` 标志不再保证范围内的所有页面都被使无效。需要 `MS\_INVALIDATE` 旧语义并且不关心已修复的安全问题的用户可以将 sysctl `vm.old\_msync` 设置为 `1`，以恢复旧的（不安全的）行为。更多信息请参见安全公告 [FreeBSD-SA-04:11](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:11.msync.asc)。[MERGED]

修复了 [jail(2)](http://www.freebsd.org/cgi/man.cgi?query=jail&sektion=2&manpath=FreeBSD+5.3-RELEASE) 系统调用中的编程错误，该错误导致未能验证是否有尝试操作路由表的进程来自非 jail 进程。更多信息请参见安全公告 [FreeBSD-SA-04:12](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:12.jail.asc)。[MERGED]

修复了处理某些 Linux 系统调用时可能导致内存位置在未经适当验证的情况下被访问的编程错误。更多信息请参见安全公告 [FreeBSD-SA-04:13](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:13.linux.asc)。[MERGED]

修复了多个 **CVS** 中的编程错误，这些错误可能导致信息泄露、拒绝服务或可能的任意代码执行，并通过升级到 **CVS** 1.11.17 进行修复。更多信息请参见安全公告 [FreeBSD-SA-04:14](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:14.cvs.asc)。

修复了 `CONS\_SCRSHOT` [ioctl(2)](http://www.freebsd.org/cgi/man.cgi?query=ioctl&sektion=2&manpath=FreeBSD+5.3-RELEASE) 中的一个 bug，该 bug 可能允许未经授权访问内核内存的某些部分，可能导致敏感信息泄露、绕过访问控制机制或特权提升。更多信息请参见安全公告 [FreeBSD-SA-04:15](ftp://ftp.freebsd.org/pub/FreeBSD/CERT/advisories/FreeBSD-SA-04:15.syscons.asc)。

### [2.2 内核更改]()

新增并默认启用 ADAPTIVE\_MUTEXES。此更改使阻塞的互斥锁在当前拥有锁的线程执行在其他 CPU 上时，会转换为自旋锁。如果需要，可以通过设置内核选项 `NO\_ADAPTIVE\_MUTEXES` 显式禁用此功能。

新增了内核选项 ADAPTIVE\_GIANT，该选项使得在启用自适应互斥锁时，Giant 锁也以自适应方式处理。这改善了 SMP 机器的性能，并且在 i386 上默认启用。

[bus_dma(9)](http://www.freebsd.org/cgi/man.cgi?query=bus_dma&sektion=9&manpath=FreeBSD+5.3-RELEASE) 接口现在支持在加载缓冲区时透明地遵循 DMA 标签中的对齐和边界约束，`bus_dmamap_load()` 会在需要时自动使用跳跃缓冲区。此外，还增加了一组 sysctl `hw.busdma.\*` 用于 [bus_dma(9)](http://www.freebsd.org/cgi/man.cgi?query=bus_dma&sektion=9&manpath=FreeBSD+5.3-RELEASE) 统计信息。

[contigmalloc(9)](http://www.freebsd.org/cgi/man.cgi?query=contigmalloc&sektion=9&manpath=FreeBSD+5.3-RELEASE) 函数已重新实现，采用了一种新算法，大大提高了在运行程序压力下成功的概率。如果需要，仍然可以使用旧算法，通过设置 sysctl `vm.old\_contigmalloc`。更多细节请参见 [contigmalloc(9)](http://www.freebsd.org/cgi/man.cgi?query=contigmalloc&sektion=9&manpath=FreeBSD+5.3-RELEASE) 手册页面。

[devfs(5)](http://www.freebsd.org/cgi/man.cgi?query=devfs&sektion=5&manpath=FreeBSD+5.3-RELEASE) 路径规则现在在目录上正确工作。

[getvfsent(3)](http://www.freebsd.org/cgi/man.cgi?query=getvfsent&sektion=3&manpath=FreeBSD+5.3-RELEASE) API 已被移除。

已移除 `hw.pci.allow\_unsupported\_io\_range` 加载器可调选项。

[jail(2)](http://www.freebsd.org/cgi/man.cgi?query=jail&sektion=2&manpath=FreeBSD+5.3-RELEASE) 现在支持在 jail 内使用原始套接字。此功能默认禁用，可以通过使用 sysctl `security.jail.allow\_raw\_sockets` 来控制。

[kqueue(2)](http://www.freebsd.org/cgi/man.cgi?query=kqueue&sektion=2&manpath=FreeBSD+5.3-RELEASE) 现在支持一个新过滤器 `EVFILT\_FS`，用于将通用文件系统事件信号传递给用户空间。目前，挂载、卸载和 NFS 的上下状态已通过此过滤器发出信号。

新增了 KDB，这是一个新的调试框架。它包含一个新的 GDB 后端，该后端已重写以支持线程、行程长度编码压缩等，以及一个前端，提供一个框架，允许配置多个不同的调试后端，并为这些后端提供基本服务。以下选项已更改：

* 默认通过内核选项启用 KDB，选项为 KDB、GDB 和 DDB。DDB 和 GDB 指定包含哪些 KDB 后端。
* `WITNESS\_DDB` 已重命名为 `WITNESS\_KDB`。
* `DDB\_TRACE` 已重命名为 `KDB\_TRACE`。
* `DDB\_UNATTENDED` 已重命名为 `KDB\_UNATTENDED`。
* `SC\_HISTORY\_DDBKEY` 已重命名为 `SC\_HISTORY\_KDBKEY`。
* `DDB\_NOKLDSYM` 已移除。新的 DDB 后端同时支持预链接符号查找和 KLD 符号查找。
* `GDB\_REMOTE\_CHAT` 已移除。允许该功能的 GDB 协议黑客是 FreeBSD 特有的。同时，GDB 协议现在为控制台输出提供数据包。

KDB 还作为所有希望使用调试功能的代码的唯一接触点，例如进入调试器或处理备用中断序列。为此，前端已被设置为非可选。所有调试请求将转发或交给当前的后端（如果适用）。当前后端的选择由 sysctl `debug.kdb.current` 控制。可以通过 sysctl `debug.kdb.available`  获取已配置的后端列表。可以通过向 sysctl `debug.kdb.enter`  写入数据来进入调试器。

新增了 sysctl `debug.kdb.stop\_cpus`。它控制是否在进入调试器时向其他 CPU 发送 IPI（处理器间中断），以便在调试器中停止它们。

现在，加载的内核模块在 amd64 构建中能够正常工作并已启用。

已增加对在 amd64 上运行 32 位 Linux 二进制文件的初步支持。此功能通过启用 COMPAT\_LINUX32 内核选项来启用。

新增了一个内核选项 MAC\_STATIC，该选项禁用内部 MAC 框架同步，以防止 MAC 策略的动态加载和卸载。

[mac_bsdextended(4)](http://www.freebsd.org/cgi/man.cgi?query=mac_bsdextended&sektion=4&manpath=FreeBSD+5.3-RELEASE) 策略现在可以仅应用第一个匹配规则，而不是所有匹配规则。此功能可以通过设置新的 sysctl `mac\_bsdextended\_firstmatch\_enabled` 来启用。

[mac_bsdextended(4)](http://www.freebsd.org/cgi/man.cgi?query=mac_bsdextended&sektion=4&manpath=FreeBSD+5.3-RELEASE) 策略现在可以将失败的尝试记录到 syslog 的 AUTHPRIV 功能中。此功能可以通过设置新的 sysctl `mac\_bsdextended\_logging` 来启用。

mballoc 已被 mbuma 替代，mbuma 是基于 UMA 框架扩展构建的 Mbuf 和 Cluster 分配器。由于这一更改，NMBCLUSTERS 内核选项不再使用。集群的最大数量仍然根据 `maxusers` 限制，但可以通过将 `kern.ipc.nmbclusters` 加载器可调选项设置为零来解除限制。

/dev/kmem、/dev/mem 和 /dev/io 现在也作为内核加载模块提供。

已修复 [mmap(2)](http://www.freebsd.org/cgi/man.cgi?query=mmap&sektion=2&manpath=FreeBSD+5.3-RELEASE) 中的一个错误，某些情况下可能会导致标记为 `PROT\_NONE` 的页面变为可读。[MERGED]

新增了加载器可调选项 `debug.mpsafenet`，默认启用。它使 FreeBSD 网络栈在没有 Giant 锁的情况下运行，从而通过增加并行性和减少网络处理延迟来提高性能。请注意，启用 [ng_tty(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_tty&sektion=4&manpath=FreeBSD+5.3-RELEASE) Netgraph 节点类型、KAME IPsec 和 IPX/SPX 子系统会导致在启动时恢复启用 Giant 锁的网络操作，或者在动态加载时发出警告，因为这些组件需要 Giant 锁才能正常工作。

新增了内核选项 `NET\_WITH\_GIANT`。该选项将 `debug.mpsafenet` 的默认值恢复为 `0`，适用于编译时包含已知不安全组件的系统，或需要更保守配置的系统。

新增了加载器可调选项 `debug.mpsafevm`。当前它导致几乎无 Giant 锁的零填充页面故障执行。

新增了内核选项 `PREEMPTION`。此选项允许内核中的线程被更高优先级的线程抢占，有助于提高交互性并使中断线程尽早运行，而不是等待。

在 sysctl dev  树中新增了 `devclass` 层级，以支持每类设备的变量，除了每个设备的变量外。这意味着 `dev.foo0.bar` 现在称为 `dev.foo.0.bar`，并且可以有 `dev.foo.bar`。

新增了 sysctl `kern.always\_console\_output`，它使得即使使用 TIOCCONS，来自内核的输出也会转到控制台。

新增了 sysctl `kern.sched.name`，它显示当前使用的调度器名称，同时将 sysctl `kern.quantum` 移动到 `kern.sched.quantum`，以保持一致性。
`
[ pci(4)](http://www.freebsd.org/cgi/man.cgi?query=pci&sektion=4&manpath=FreeBSD+5.3-RELEASE) 总线资源和电源管理已更新。

> **注意：**虽然 [pci(4)](http://www.freebsd.org/cgi/man.cgi?query=pci&sektion=4&manpath=FreeBSD+5.3-RELEASE) 总线电源状态管理默认启用，但它可能会在某些系统上引发问题。可以通过将 tunable hw.pci.do\_powerstate 设置为 0 来禁用它。

ULE 调度器已被添加为附加调度器。请注意，传统调度器 4BSD 仍然是 GENERIC 内核中的默认调度器。对于大多数用户来说，交互性在许多情况下得到了改善。这意味着在机器非常忙时，交互式应用程序中的“跳跃”和“卡顿”现象会减少。虽然它不能防止因磁盘子系统过载导致的问题，但确实有助于缓解 CPU 过载。在 SMP 机器上，ULE 有每个 CPU 的运行队列，可以支持 CPU 亲和性、CPU 绑定和高级超线程支持，并为未来的更多优化提供框架。随着细粒度内核锁的继续，调度器将能够更有效地利用可用的并行资源。

在 [vm_map_findspace(9)](http://www.freebsd.org/cgi/man.cgi?query=vm_map_findspace&sektion=9&manpath=FreeBSD+5.3-RELEASE) 中使用的线性查找算法已被替换为基于映射条目跳跃树的 O(log n) 算法。这显著减少了 [vm_map_findspace(9)](http://www.freebsd.org/cgi/man.cgi?query=vm_map_findspace&sektion=9&manpath=FreeBSD+5.3-RELEASE) 中的开销，特别是对于需要 [mmap(2)](http://www.freebsd.org/cgi/man.cgi?query=mmap&sektion=2&manpath=FreeBSD+5.3-RELEASE) 数百或数千个区域的应用程序。

加载器可调选项 `debug.witness\_\*` 已重命名为 `debug.witness.\*`。

FreeBSD 动态和静态链接器现在支持线程局部存储（TLS），这是一种 GCC 特性，支持为全局和静态变量的声明添加 `\_\_thread` 修饰符。此额外的修饰符意味着该变量的值是线程局部的，一个线程更改其值不会影响其他线程中该变量的值。

内核的文件描述符分配代码已更新，并且现在源自 OpenBSD 中类似的代码。

#### [2.2.1 启动加载器更改]()

---

#### [2.2.2 硬件支持]()

添加了驱动 [acpi_video(4)](http://www.freebsd.org/cgi/man.cgi?query=acpi_video&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，用于通过 ACPI 视频扩展控制显示切换和背光亮度。

驱动 [agp(4)](http://www.freebsd.org/cgi/man.cgi?query=agp&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现已支持 AMD64 图形光栅表（GART）。

已重写驱动 [nmdm(4)](http://www.freebsd.org/cgi/man.cgi?query=nmdm&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，以提高其可靠性。

驱动 raid(4) （来自 NetBSD 的 RAIDframe 磁盘驱动）已被移除。目前该驱动无法使用，并且需要一定的工作才能在 [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) API 下使其正常工作。

设备 [pcic(4)](http://www.freebsd.org/cgi/man.cgi?query=pcic&sektion=4&manpath=FreeBSD+5.3-RELEASE) 不再维护，已从 GENERIC 内核配置文件中移除。该条目实际上已经很长时间未使用。

对于设备 [uart(4)](http://www.freebsd.org/cgi/man.cgi?query=uart&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，新增了内核环境变量 `hw.uart.console` 和 `hw.uart.dbgport`。这些变量可分别用于选择串行控制台和调试端口，并设置相应的属性。

新增了设备驱动 [ubser(4)](http://www.freebsd.org/cgi/man.cgi?query=ubser&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，以支持 BWCT 控制台管理串行适配器。

新增了驱动 [ucycom(4)](http://www.freebsd.org/cgi/man.cgi?query=ucycom&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，支持 Cypress CY7C637xx 和 CY7C640/1xx 系列的 USB 到 RS232 桥接器，如 DeLorme Earthmate USB GPS 接收器（当前仅支持此设备）。该驱动尚不完整，因为尚未支持流控和输出。

设备驱动基础设施和许多驱动已更新。更改包括：更多的驱动现已使用自动分配的主设备号（而不是旧的静态主设备号）；已增强功能，支持伪设备的克隆；驱动 API 进行了多项更改，包括在 `struct cdevsw` 中添加了新的 `d_version` 字段。请注意，第三方设备驱动在此更改后需要重新编译。

---

##### [2.2.2.1 多媒体支持]()

由于损坏和缺乏维护，已移除驱动 [meteor（视频捕获）](http://www.freebsd.org/cgi/man.cgi?query=meteor&sektion=4&manpath=FreeBSD+5.3-RELEASE) 。

Direct Rendering Manager（DRM）代码已从 DRI 项目 CVS 树（截至 2004 年 5 月 26 日）进行更新。此更新包括新的 PCI ID 和 Radeon 的新数据包。

各种声卡的驱动程序已重新组织；设备声音是通用声音驱动，设备 `snd_\*` 是特定设备的声音驱动程序。支持串口和若干声卡的驱动 midi 已被移除。更多详细信息可参见相关手册页：[sound(4)](http://www.freebsd.org/cgi/man.cgi?query=sound&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_ad1816(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_ad1816&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_als4000(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_als4000&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_cmi(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_cmi&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_cs4281(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_cs4281&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_csa(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_csa&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_ds1(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_ds1&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_emu10k1(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_emu10k1&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_es137x(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_es137x&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_gusc(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_gusc&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_maestro3(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_maestro3&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_sbc(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_sbc&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_solo(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_solo&sektion=4&manpath=FreeBSD+5.3-RELEASE)、[snd_uaudio(4)](http://www.freebsd.org/cgi/man.cgi?query=snd_uaudio&sektion=4&manpath=FreeBSD+5.3-RELEASE)。

驱动 [sound(4)](http://www.freebsd.org/cgi/man.cgi?query=sound&sektion=4&manpath=FreeBSD+5.3-RELEASE) （之前称为 [pcm(4)](http://www.freebsd.org/cgi/man.cgi?query=pcm&sektion=4&manpath=FreeBSD+5.3-RELEASE)）已被修改，以便在启动时读取 /boot/device.hints 文件，从而允许设置默认的混音器通道值。请注意，当前在 `/boot/device.hints` 中使用的设备驱动程序名称仍为 pcm。更多详细信息和示例可以在 [sound(4)](http://www.freebsd.org/cgi/man.cgi?query=sound&sektion=4&manpath=FreeBSD+5.3-RELEASE) 手册页中找到。

##### [2.2.2.2 网络接口支持]()

在驱动程序 [em(4)](http://www.freebsd.org/cgi/man.cgi?query=em&sektion=4&manpath=FreeBSD+5.3-RELEASE) 中修复了一个在参数重新配置时的短暂中断问题。[合并]

增加了驱动程序 [fwip(4)](http://www.freebsd.org/cgi/man.cgi?query=fwip&sektion=4&manpath=FreeBSD+5.3-RELEASE)，它支持通过 FireWire 传输 IP。需要注意的是，目前广播通道号是硬编码的，且不支持用于多播通道分配的 MCAP。该驱动程序旨在符合 IP over FireWire 的 RFC 2734 和 RFC 3146 标准，最终将替代驱动程序 [fwe(4)](http://www.freebsd.org/cgi/man.cgi?query=fwe&sektion=4&manpath=FreeBSD+5.3-RELEASE) 。

[fxp(4)](http://www.freebsd.org/cgi/man.cgi?query=fxp&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在使用设备 sysctl 树，例如 `dev.fxp0`，可以基于每个设备设置这些 sysctl。

[fxp(4)](http://www.freebsd.org/cgi/man.cgi?query=fxp&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在可以实际控制接收扩展以太网帧的能力，这由 VLAN_MTU 接口能力指示。可以通过 [ifconfig(8)](http://www.freebsd.org/cgi/man.cgi?query=ifconfig&sektion=8&manpath=FreeBSD+5.3-RELEASE) 中的 `vlanmtu` 和 `-vlanmtu` 选项从用户空间切换此设置。

驱动程序 [hme(4)](http://www.freebsd.org/cgi/man.cgi?query=hme&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在本地支持长帧，因此可以用于 [vlan(4)](http://www.freebsd.org/cgi/man.cgi?query=vlan&sektion=4&manpath=FreeBSD+5.3-RELEASE)，支持完整的以太网 MTU 大小。

驱动程序 [hme(4)](http://www.freebsd.org/cgi/man.cgi?query=hme&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在支持 TCP/UDP 的发送/接收校验和卸载。由于 [hme(4)](http://www.freebsd.org/cgi/man.cgi?query=hme&sektion=4&manpath=FreeBSD+5.3-RELEASE) 未对 UDP 数据报进行校验和补偿，这可能会导致校验和为 `0x0`，因此 UDP 发送校验和卸载默认是禁用的。可以通过[ifconfig(8)](http://www.freebsd.org/cgi/man.cgi?query=ifconfig&sektion=8&manpath=FreeBSD+5.3-RELEASE) 中的特殊链接选项 link0 重新启用。

驱动程序 [ixgb(4)](http://www.freebsd.org/cgi/man.cgi?query=ixgb&sektion=4&manpath=FreeBSD+5.3-RELEASE)（支持 Intel PRO/10GBE 10 千兆以太网卡）已被添加。[合并]

已修复一个 BUG，该 BUG 会导致驱动程序 [nge(4)](http://www.freebsd.org/cgi/man.cgi?query=nge&sektion=4&manpath=FreeBSD+5.3-RELEASE) 中的 VLAN 支持无法正常工作。[合并]

已修复多个与 [polling(4)](http://www.freebsd.org/cgi/man.cgi?query=polling&sektion=4&manpath=FreeBSD+5.3-RELEASE) 支持相关的 BUG，这些 BUG 出现在驱动程序 [rl(4)](http://www.freebsd.org/cgi/man.cgi?query=rl&sektion=4&manpath=FreeBSD+5.3-RELEASE)中。[合并]

修复了驱动程序 [sk(4)](http://www.freebsd.org/cgi/man.cgi?query=sk&sektion=4&manpath=FreeBSD+5.3-RELEASE) 中与多播和混杂模式处理相关的多个 BUG。

驱动程序 [ste(4)](http://www.freebsd.org/cgi/man.cgi?query=ste&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在支持 [polling(4)](http://www.freebsd.org/cgi/man.cgi?query=polling&sektion=4&manpath=FreeBSD+5.3-RELEASE)。[合并]

增加了驱动程序 [udav(4)](http://www.freebsd.org/cgi/man.cgi?query=udav&sektion=4&manpath=FreeBSD+5.3-RELEASE)，它支持基于 Davicom DM9601 芯片组的 USB 以太网适配器。

增加了驱动程序 [vge(4)](http://www.freebsd.org/cgi/man.cgi?query=vge&sektion=4&manpath=FreeBSD+5.3-RELEASE)，它支持 VIA Networking Technologies VT6122 千兆以太网芯片及集成的 10/100/1000 铜 PHY。

驱动程序 [vr(4)](http://www.freebsd.org/cgi/man.cgi?query=vr&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在支持 [polling(4)](http://www.freebsd.org/cgi/man.cgi?query=polling&sektion=4&manpath=FreeBSD+5.3-RELEASE)。[合并]

驱动程序 [xl(4)](http://www.freebsd.org/cgi/man.cgi?query=xl&sektion=4&manpath=FreeBSD+5.3-RELEASE) 中的硬件 TX 校验和支持已被禁用，因为它不能正常工作并且会降低传输速率。[合并]

现在可以基于每个接口启用 [polling(4)](http://www.freebsd.org/cgi/man.cgi?query=polling&sektion=4&manpath=FreeBSD+5.3-RELEASE) 支持。以下网络驱动程序支持 [polling(4)](http://www.freebsd.org/cgi/man.cgi?query=polling&sektion=4&manpath=FreeBSD+5.3-RELEASE)：[dc(4)](http://www.freebsd.org/cgi/man.cgi?query=dc&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[fxp(4)](http://www.freebsd.org/cgi/man.cgi?query=fxp&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[em(4)](http://www.freebsd.org/cgi/man.cgi?query=em&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[ixgb(4)](http://www.freebsd.org/cgi/man.cgi?query=ixgb&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[nge(4)](http://www.freebsd.org/cgi/man.cgi?query=nge&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[re(4)](http://www.freebsd.org/cgi/man.cgi?query=re&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[rl(4)](http://www.freebsd.org/cgi/man.cgi?query=rl&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[sis(4)](http://www.freebsd.org/cgi/man.cgi?query=sis&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[ste(4)](http://www.freebsd.org/cgi/man.cgi?query=ste&sektion=4&manpath=FreeBSD+5.3-RELEASE)，[vge(4)](http://www.freebsd.org/cgi/man.cgi?query=vge&sektion=4&manpath=FreeBSD+5.3-RELEASE)，和 [vr(4)](http://www.freebsd.org/cgi/man.cgi?query=vr&sektion=4&manpath=FreeBSD+5.3-RELEASE)。它们现在也支持该功能，并且可以通过 [ifconfig(8)](http://www.freebsd.org/cgi/man.cgi?query=ifconfig&sektion=8&manpath=FreeBSD+5.3-RELEASE)进行控制，除了[ixgb(4)](http://www.freebsd.org/cgi/man.cgi?query=ixgb&sektion=4&manpath=FreeBSD+5.3-RELEASE)。[合并]

#### [2.2.3 网络协议]()

隧道驱动程序 [gre(4)](http://www.freebsd.org/cgi/man.cgi?query=gre&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在支持 WCCP 版本 2。

[ipfw(4)](http://www.freebsd.org/cgi/man.cgi?query=ipfw&sektion=4&manpath=FreeBSD+5.3-RELEASE) 规则现在支持选项 `versrcreach` ，用于验证路由表中是否存在有效的源地址路由。这个选项对于具有完整互联网视图（BGP）的路由器非常有用，可以拒绝源地址伪造或无法路由的数据包。例如：

```
deny ip from any to any not versrcreach
```

这等同于以下 Cisco IOS 语法：

```
ip verify unicast source reachable-via any
```

[ipfw(4)](http://www.freebsd.org/cgi/man.cgi?query=ipfw&sektion=4&manpath=FreeBSD+5.3-RELEASE) 规则现在支持选项 `antispoof`，用于验证传入数据包的源地址是否属于直接连接的网络。如果网络是直接连接的，那么接收数据包的接口将与网络连接的接口进行比较。当传入接口和直接连接的接口不同时，数据包不匹配。例如：

```
deny ip from any to any not antispoof in
```

[ipfw(4)](http://www.freebsd.org/cgi/man.cgi?query=ipfw&sektion=4&manpath=FreeBSD+5.3-RELEASE) 规则现在支持选项 `jail` ，用于将规则与特定的监狱 ID 关联。例如：

```
count ip from any to any jail 2
```

请注意，此规则当前仅适用于 TCP 和 UDP 数据包。

[ipfw(4)](http://www.freebsd.org/cgi/man.cgi?query=ipfw&sektion=4&manpath=FreeBSD+5.3-RELEASE)现在支持查找表。这个功能对于处理大规模稀疏地址集非常有用。[合并]

[ipfw(4)](http://www.freebsd.org/cgi/man.cgi?query=ipfw&sektion=4&manpath=FreeBSD+5.3-RELEASE)转发规则必须通过内核选项 IPFIREWALL_FORWARD 编译到内核中才能启用。

添加了一个新的 sysctl `net.inet.ip.process_options`，用于控制 IP 选项的处理。当该 sysctl 设置为 `0` 时，IP 选项会被忽略并且未修改地传递；设置为 1 时，所有 IP 选项都将被处理（默认）；设置为 `2` 时，所有带有 IP 选项的包将被拒绝，并返回 ICMP 过滤禁止消息。

修复了 KAME 项目中 IPsec 实现的一些 BUG。这些 BUG 与在删除所有引用之前释放内存对象有关，可能会导致在刷新安全策略数据库（SPD）后出现不稳定行为或内核恐慌。

[natd(8)](http://www.freebsd.org/cgi/man.cgi?query=natd&sektion=8&manpath=FreeBSD+5.3-RELEASE) 现在支持通过新选项 `globalports` 运行多个实例。这允许 [natd(8)](http://www.freebsd.org/cgi/man.cgi?query=natd&sektion=8&manpath=FreeBSD+5.3-RELEASE) 绑定到不同的网络接口并共享负载。

Netgraph 节点类型 [ng_atmllc(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_atmllc&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，处理 RFC 1483 ATM LLC 封装，已添加。

Netgraph 节点类型 [ng_hub(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_hub&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，支持类似以太网集线器的简单数据包分发，已添加。[合并]

Netgraph 节点类型 [ng_rfc1490(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_rfc1490&sektion=4&manpath=FreeBSD+5.3-RELEASE) 现在支持 Cisco 风格的封装，通常与 RFC 1490 一起用于帧中继链路。

已添加 Netgraph 节点类型 [ng_sppp(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_sppp&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，是原始 [sppp(4)](http://www.freebsd.org/cgi/man.cgi?query=sppp&sektion=4&manpath=FreeBSD+5.3-RELEASE)网络模块（用于同步线路）的[netgraph(4)](http://www.freebsd.org/cgi/man.cgi?query=netgraph&sektion=4&manpath=FreeBSD+5.3-RELEASE)接口。

添加了一种新的 Netgraph 方法，以恢复从 4.X 风格 [ng_tee(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_tee&sektion=4&manpath=FreeBSD+5.3-RELEASE) Netgraph 节点变更中丧失的部分行为。

Netgraph 节点类型 [ng_vlan(4)](http://www.freebsd.org/cgi/man.cgi?query=ng_vlan&sektion=4&manpath=FreeBSD+5.3-RELEASE) ，支持 IEEE 802.1Q VLAN 标记，已添加。[合并]

`PFIL_HOOKS` 支持现在始终编译进内核，相关的内核编译选项已被删除。FreeBSD 支持的所有数据包过滤子系统现在都使用 `PFIL_HOOKS` 框架。

以太网媒体支持的链路状态更改通知已添加到路由套接字。

[ppp(8)](http://www.freebsd.org/cgi/man.cgi?query=ppp&sektion=8&manpath=FreeBSD+5.3-RELEASE) 中的链路质量监控（LQM）支持已重新实现。LQM（在 RFC 1989 中描述）允许 PPP 跟踪正在运行的连接的质量。[合并]

伪接口克隆已更新，并且匹配功能已允许创建名为 stf0、stf 或 6to4 的 [stf(4)](http://www.freebsd.org/cgi/man.cgi?query=stf&sektion=4&manpath=FreeBSD+5.3-RELEASE) 接口。请注意，这破坏了向后兼容性；例如，`ifconfig stf` 现在创建名为 `stf` 的接口，而不是 `stf0`，并且不再将 `stf0` 打印到标准输出。

以下 TCP 功能现在默认启用：RFC 3042（有限重传）、RFC 3390（增加初始拥塞窗口大小）、TCP 带宽-延迟积限制。这些功能的 sysctl 变量包括 `net.inet.tcp.rfc3042`、`net.inet.tcp.rfc3390` 和 `net.inet.tcp.inflight.enable`。更多信息请参见 [tcp(4)](http://www.freebsd.org/cgi/man.cgi?query=tcp&sektion=4&manpath=FreeBSD+5.3-RELEASE)。

FreeBSD 的 TCP 实现现在支持最小 MSS（通过 sysctl 变量 `net.inet.tcp.minmss` 设置）和对在短时间内发送许多小 TCP 段的连接的速率限制（通过 sysctl 变量 `net.inet.tcp.minmssoverload`）。超过此限制的连接可能会被重置和丢弃。此功能提供了对资源耗尽攻击的一种保护。

TCP 实现现在包括对 RFC 2385（TCP-MD5）摘要支持的部分（仅输出）支持。此功能通过内核选项 `TCP_SIGNATURE` 和 `FAST_IPSEC` 启用，是一种用于验证 TCP 会话的 TCP 选项。[setkey(8)](http://www.freebsd.org/cgi/man.cgi?query=setkey&sektion=8&manpath=FreeBSD+5.3-RELEASE) 现在包括对 TCP-MD5 安全关联类的支持。[合并]

TCP 连接重置处理已得到改进，以使几种重置攻击尽可能困难，同时保持与最广泛范围的 TCP 栈的兼容性。

RFC 1948 的实现已得到改进。初始序列号（ISN）的时间偏移组件现在包括时钟滴答之间的随机正增量，因此无论端口回收多快，ISN 总是会增加。

已实现 OpenBSD 的随机临时端口分配。默认启用，用户可以通过使用 sysctl `net.inet.ip.portrange.randomized` 禁用。[合并]

已添加 RFC 2018 中描述的 TCP 选择性确认（SACK）。这改善了在丢包严重的连接上的 TCP 性能。SACK 可以通过 sysctl `net.inet.tcp.sack.enable` 启用。


#### [2.2.4 磁盘与存储]()

[ata(4)](http://www.freebsd.org/cgi/man.cgi?query=ata&sektion=4&manpath=FreeBSD+5.3-RELEASE) 驱动现在支持 [cardbus(4)](http://www.freebsd.org/cgi/man.cgi?query=cardbus&sektion=4&manpath=FreeBSD+5.3-RELEASE) ATA/SATA 控制器。

[ata(4)](http://www.freebsd.org/cgi/man.cgi?query=ata&sektion=4&manpath=FreeBSD+5.3-RELEASE) 驱动中的一些错误已被修复，特别是主/从设备检测应该能更好地工作，并且一些超时问题已得到解决。

[ata(4)](http://www.freebsd.org/cgi/man.cgi?query=ata&sektion=4&manpath=FreeBSD+5.3-RELEASE) 驱动现在支持所有现代 Promise 控制器（PDC203** PDC206**）上的 Promise 命令序列器。

> **注意：** 这也为 Promise SX4/SX4000 作为“普通”Promise ATA 控制器添加了初步支持；ATA RAID 被支持，但仅支持 RAID0、RAID1 和 RAID0+1。

已移除用于 CAM SCSI 磁盘驱动程序（[cam(4)](http://www.freebsd.org/cgi/man.cgi?query=cam&sektion=4&manpath=FreeBSD+5.3-RELEASE)）的 DA_OLD_QUIRKS 内核选项。[合并]

修复了[geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE)中的一个错误，该错误可能会在一些罕见情况下导致 I/O 挂起。

添加了新的 GEOM_CONCAT [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE)类，用于将多个磁盘连接成一个更大的单一磁盘。

添加了新的 GEOM_NOP [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，用于各种测试目的。

添加了新的 GEOM_RAID3 [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，用于 RAID3 转换，以及[graid3(8)](http://www.freebsd.org/cgi/man.cgi?query=graid3&sektion=8&manpath=FreeBSD+5.3-RELEASE)用户空间实用工具。

添加了新的 GEOM_STRIPE [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，实现 RAID0 转换。此类有两种模式：“快速”和“经济”。在快速模式下，当使用非常小的条带大小时，将向每个磁盘发送一个 I/O 请求；对于小条带大小，快速模式比经济模式和其他 RAID0 实现快大约 10 倍。虽然默认使用快速模式，但它消耗的内存比经济模式多，经济模式每次发送请求时使用。可以通过将加载器可调 kern.geom.stripe.fast 设置为 0 来启用经济模式。还可以通过设置加载器可调 kern.geom.stripe.maxmem 来指定快速模式可以消耗的最大内存。

GEOM Gate 已添加，包含一个新的 GEOM_GATE [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类和多个 GEOM Gate 用户空间实用工具（[ggatel(8)](http://www.freebsd.org/cgi/man.cgi?query=ggatel&sektion=8&manpath=FreeBSD+5.3-RELEASE)、[ggatec(8)](http://www.freebsd.org/cgi/man.cgi?query=ggatec&sektion=8&manpath=FreeBSD+5.3-RELEASE)、[ggated(8)](http://www.freebsd.org/cgi/man.cgi?query=ggated&sektion=8&manpath=FreeBSD+5.3-RELEASE)）。它支持通过网络导出设备，包括非[geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE)-感知设备。

添加了新的 GEOM_LABEL [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，用于检测各种文件系统上的卷标签，如 UFS、MSDOSFS（FAT12、FAT16、FAT32）和 ISO9660。

添加了新的 GEOM_GPT [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，支持 GUID 分区表（GPT）分区，并允许在单个磁盘上拥有大量分区，默认已加入 GENERIC。

添加了新的 GEOM_MIRROR [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，支持 RAID1 功能。可以使用[gmirror(8)](http://www.freebsd.org/cgi/man.cgi?query=gmirror&sektion=8&manpath=FreeBSD+5.3-RELEASE)实用工具来控制此类。

添加了新的 GEOM_UZIP [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，实现只读压缩磁盘。当前支持 cloop V2.0 磁盘压缩格式。

添加了新的 GEOM_VINUM [geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE) 类，支持 [vinum(4)](http://www.freebsd.org/cgi/man.cgi?query=vinum&sektion=4&manpath=FreeBSD+5.3-RELEASE)和[geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE)之间的合作。

[ips(4)](http://www.freebsd.org/cgi/man.cgi?query=ips&sektion=4&manpath=FreeBSD+5.3-RELEASE) 驱动现在支持最近的 Adaptec ServeRAID 系列 SCSI 控制器卡。

[umass(4)](http://www.freebsd.org/cgi/man.cgi?query=umass&sektion=4&manpath=FreeBSD+5.3-RELEASE) 驱动现在支持缺失的 ATAPI MMC 命令并正确处理超时。[合并]

[vinum(4)](http://www.freebsd.org/cgi/man.cgi?query=vinum&sektion=4&manpath=FreeBSD+5.3-RELEASE)卷管理器已更新，使用[geom(4)](http://www.freebsd.org/cgi/man.cgi?query=geom&sektion=4&manpath=FreeBSD+5.3-RELEASE)磁盘 I/O 请求转换框架。已添加 gvinum 用户空间实用工具。

已添加对 LSI 类型软件 RAID 的支持。

